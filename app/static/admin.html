<!DOCTYPE html>
<html lang="en" data-theme="quilt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Admin panel for Store Insights - User and database management" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Store Insights - Admin Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Tailwind CSS - Compiled -->
    <link rel="stylesheet" href="/tailwind.css">
  </head>
  <body>
    <div id="root"></div>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Component Library -->
    <script src="/theme-switcher.js"></script>
    <script>
      // Initialize theme immediately to ensure CSS variables are set
      (function() {
        // Set theme attribute immediately (before ThemeSwitcher loads)
        const savedTheme = localStorage.getItem('store-insights-theme') || 'quilt';
        document.documentElement.setAttribute('data-theme', savedTheme);
        
        // Initialize ThemeSwitcher when it loads
        if (typeof ThemeSwitcher !== 'undefined') {
          ThemeSwitcher.init();
        } else {
          // Wait for ThemeSwitcher to load
          const checkThemeSwitcher = setInterval(function() {
            if (typeof ThemeSwitcher !== 'undefined') {
              ThemeSwitcher.init();
              clearInterval(checkThemeSwitcher);
            }
          }, 50);
          
          // Timeout after 2 seconds
          setTimeout(function() {
            clearInterval(checkThemeSwitcher);
          }, 2000);
        }
      })();
    </script>
    <script src="/components/component-loader.js"></script>
    <script type="text/babel">
      const { useState, useEffect, useCallback, useMemo, useRef } = React;

      const API_BASE = window.location.origin;

      // Storage helper
      const storage = {
        get: (key, defaultValue) => {
          try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : defaultValue;
          } catch {
            return defaultValue;
          }
        },
        set: (key, value) => {
          try {
            localStorage.setItem(key, JSON.stringify(value));
          } catch {}
        },
        remove: (key) => {
          try {
            localStorage.removeItem(key);
          } catch {}
        },
      };

      const STORAGE_KEYS = {
        token: 'store-insights/token',
        adminKey: 'store-insights/admin-key',
        role: 'store-insights/role',
        profile: 'store-insights/profile',
        stores: 'store-insights/stores',
        selectedStore: 'store-insights/selected-store',
      };

      // Clear all session data
      const clearSession = () => {
        Object.values(STORAGE_KEYS).forEach(key => {
          storage.remove(key);
        });
      };

      // Helper functions
      const getStoreIdentifier = (store) => {
        if (store?.id) return String(store.id);
        if (store?.store_db) return store.store_db;
        return null;
      };

      const formatRole = (role) => {
        if (!role) return 'User';
        return role.charAt(0).toUpperCase() + role.slice(1);
      };

      const getPrivilegeBadge = (privilegeLevel) => {
        if (!privilegeLevel) return null;
        const level = privilegeLevel.toLowerCase();
        
        const badgeStyles = {
          read_only: 'bg-yellow-100 text-yellow-800 border-yellow-200',
          read_write: 'bg-blue-100 text-blue-800 border-blue-200',
          full_access: 'bg-green-100 text-green-800 border-green-200',
        };
        
        const label = {
          read_only: 'Read Only',
          read_write: 'Read/Write',
          full_access: 'Full Access',
        }[level] || 'Read/Write';

        return (
          <span 
            className={`inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold ${badgeStyles[level] || badgeStyles.read_write}`}
            title={
              level === 'read_only' ? 'SELECT only' :
              level === 'read_write' ? 'SELECT, INSERT, UPDATE, DELETE' :
              'All privileges including CREATE, DROP, ALTER'
            }
          >
            {label}
          </span>
        );
      };

      // Helper to decode JWT token
      const decodeToken = (token) => {
        try {
          const payload = JSON.parse(atob(token.split('.')[1]));
          return payload;
        } catch {
          return null;
        }
      };

      // Components (Button, Input, Label, Select are now loaded from component library)
      const CreateUserForm = ({ onSubmit, isSubmitting, knownStores = [], onEnsureStore }) => {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [fullName, setFullName] = useState('');
        const [role, setRole] = useState('owner');
        const [storeDb, setStoreDb] = useState('');
        const [storeUser, setStoreUser] = useState('');
        const [storePass, setStorePass] = useState('');
        const [storeName, setStoreName] = useState('');
        const [storeSearch, setStoreSearch] = useState('');
        const [privilegeLevel, setPrivilegeLevel] = useState('read_write');
        const [passwordStrength, setPasswordStrength] = useState(0);
        const [formError, setFormError] = useState('');

        const suggestions = useMemo(() => {
          const q = (storeSearch || '').toLowerCase();
          if (!q) return knownStores;
          return knownStores.filter((s) =>
            (s.label || '').toLowerCase().includes(q) || (s.store_db || '').toLowerCase().includes(q)
          );
        }, [storeSearch, knownStores]);

        const applySuggestion = (value) => {
          const choice = knownStores.find(
            (s) => s.store_db === value || s.label === value
          );
          if (choice) {
            setStoreDb(choice.store_db || '');
            setStoreName(choice.store_name || choice.label || '');
          }
        };

        const calculatePasswordStrength = (pwd) => {
          let strength = 0;
          if (pwd.length >= 8) strength++;
          if (pwd.length >= 12) strength++;
          if (/[a-z]/.test(pwd) && /[A-Z]/.test(pwd)) strength++;
          if (/\d/.test(pwd)) strength++;
          if (/[^a-zA-Z\d]/.test(pwd)) strength++;
          return Math.min(strength, 5);
        };

        const generatePassword = () => {
          const length = 16;
          const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
          let password = '';
          for (let i = 0; i < length; i++) {
            password += charset.charAt(Math.floor(Math.random() * charset.length));
          }
          setStorePass(password);
          setPasswordStrength(calculatePasswordStrength(password));
        };

        const handleSubmit = async (e) => {
          e.preventDefault();
          setFormError('');

          if (!email.trim() || !password.trim()) {
            setFormError('Email and password are required');
            return;
          }

          const stores = [];
          if (storeDb.trim() || storeUser.trim() || storePass.trim() || storeName.trim()) {
            if (!storeDb.trim() || !storeUser.trim() || !storePass.trim()) {
              setFormError('Store database, user, and password are required for the first assignment');
              return;
            }
            stores.push({
              store_db: storeDb.trim(),
              db_user: storeUser.trim(),
              db_pass: storePass,
              store_name: storeName.trim() || undefined,
              privilege_level: privilegeLevel,
            });
          }

          const success = await onSubmit({
            email: email.trim(),
            password: password.trim(),
            full_name: fullName.trim() || undefined,
            user_role: role,
            stores,
          });

          if (success) {
            setEmail('');
            setPassword('');
            setFullName('');
            setRole('owner');
            setStoreDb('');
            setStoreUser('');
            setStorePass('');
            setStoreName('');
            setPrivilegeLevel('read_write');
            setPasswordStrength(0);
          }
        };

        return (
          <form className="bg-card text-card-foreground border border-border rounded-lg p-8 shadow-sm hover:shadow-md transition-shadow" onSubmit={handleSubmit}>
            <div className="flex items-center justify-between mb-6 pb-4 border-b border-border">
              <div>
                <div className="text-xl font-semibold text-foreground">Create User</div>
                <div className="text-sm text-muted-foreground mt-1">Add a new user account with store access</div>
              </div>
            </div>
            {formError && (
              <div className="relative w-full rounded-lg border border-destructive/50 bg-destructive/10 p-4 text-sm text-destructive mb-6">
                {formError}
              </div>
            )}
            
            <div className="mb-6">
              <Label>Search stores</Label>
              <Input
                type="text"
                value={storeSearch}
                onChange={(e) => setStoreSearch(e.target.value)}
                list="known-stores-datalist"
                placeholder="Start typing to search known stores"
                disabled={isSubmitting}
                onBlur={(e) => applySuggestion(e.target.value)}
              />
              <datalist id="known-stores-datalist">
                {suggestions.map((s) => (
                  <option key={s.store_db} value={s.store_db}>{s.label}</option>
                ))}
              </datalist>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div>
                <Label>Email *</Label>
                <Input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="manager@example.com"
                  required
                  disabled={isSubmitting}
                />
              </div>
              <div>
                <Label>Password *</Label>
                <div className="flex gap-2">
                  <Input
                    type="password"
                    value={password}
                    onChange={(e) => {
                      setPassword(e.target.value);
                      setPasswordStrength(calculatePasswordStrength(e.target.value));
                    }}
                    placeholder="Minimum 8 characters"
                    required
                    disabled={isSubmitting}
                    className="flex-1"
                  />
                  <Button
                    type="button"
                    variant="secondary"
                    onClick={generatePassword}
                    disabled={isSubmitting}
                    title="Generate secure password"
                  >
                    Generate
                  </Button>
                </div>
                {password && (
                  <div className="mt-2">
                    <div className="flex gap-1 mb-2">
                      {[1, 2, 3, 4, 5].map((level) => (
                        <div
                          key={level}
                          className={`flex-1 h-1 rounded ${
                            level <= passwordStrength
                              ? level <= 2 ? 'bg-destructive' : level <= 4 ? 'bg-yellow-500' : 'bg-green-500'
                              : 'bg-muted'
                          }`}
                        />
                      ))}
                    </div>
                    <div className={`text-xs font-medium ${
                      passwordStrength <= 2 ? 'text-destructive' : passwordStrength <= 4 ? 'text-yellow-600' : 'text-green-600'
                    }`}>
                      {passwordStrength <= 2 ? 'Weak' : passwordStrength <= 4 ? 'Medium' : 'Strong'}
                    </div>
                  </div>
                )}
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div>
                <Label>Full name (optional)</Label>
                <Input
                  type="text"
                  value={fullName}
                  onChange={(e) => setFullName(e.target.value)}
                  disabled={isSubmitting}
                />
              </div>
              <div>
                <Label>Role</Label>
                <Select value={role} onChange={(e) => setRole(e.target.value)} disabled={isSubmitting}>
                  <option value="owner">Owner</option>
                  <option value="user">User</option>
                  <option value="admin">Admin</option>
                </Select>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
              <div>
                <Label>Store database</Label>
                <Input
                  type="text"
                  value={storeDb}
                  onChange={(e) => setStoreDb(e.target.value)}
                  placeholder="spirits_6885"
                  disabled={isSubmitting}
                />
              </div>
              <div>
                <Label>DB user</Label>
                <Input
                  type="text"
                  value={storeUser}
                  onChange={(e) => setStoreUser(e.target.value)}
                  placeholder="store_user"
                  disabled={isSubmitting}
                />
              </div>
              <div>
                <Label>DB password</Label>
                <Input
                  type="password"
                  value={storePass}
                  onChange={(e) => setStorePass(e.target.value)}
                  placeholder="secret"
                  disabled={isSubmitting}
                />
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div>
                <Label>Store name</Label>
                <Input
                  type="text"
                  value={storeName}
                  onChange={(e) => setStoreName(e.target.value)}
                  placeholder="Downtown Spirits"
                  disabled={isSubmitting}
                />
              </div>
              <div>
                <Label>Privilege level</Label>
                <Select
                  value={privilegeLevel}
                  onChange={(e) => setPrivilegeLevel(e.target.value)}
                  disabled={isSubmitting}
                >
                  <option value="read_only">Read Only (SELECT)</option>
                  <option value="read_write">Read/Write (SELECT, INSERT, UPDATE, DELETE)</option>
                  <option value="full_access">Full Access (All privileges)</option>
                </Select>
                <p className="text-xs text-muted-foreground mt-1">
                  {privilegeLevel === 'read_only' && 'User can only read data'}
                  {privilegeLevel === 'read_write' && 'User can read and modify data'}
                  {privilegeLevel === 'full_access' && 'User has full database access including schema changes'}
                </p>
              </div>
            </div>

            <div className="flex gap-3 flex-wrap">
              <Button
                type="button"
                variant="secondary"
                disabled={isSubmitting || !storeDb || !storeUser || !storePass}
                onClick={async () => {
                  if (!onEnsureStore) return;
                  await onEnsureStore({
                    store_db: storeDb.trim(),
                    db_user: storeUser.trim(),
                    db_pass: storePass,
                    privilege_level: privilegeLevel,
                  });
                }}
              >
                Ensure database exists
              </Button>
              <Button type="submit" variant="default" disabled={isSubmitting}>
                {isSubmitting ? 'Creating...' : 'Create user'}
              </Button>
            </div>
          </form>
        );
      };

      const AddStoreForm = ({ user, onSubmit, isSubmitting, userId }) => {
        const [storeDb, setStoreDb] = useState('');
        const [storeUser, setStoreUser] = useState('');
        const [storePass, setStorePass] = useState('');
        const [storeName, setStoreName] = useState('');
        const [privilegeLevel, setPrivilegeLevel] = useState('read_write');
        const [formError, setFormError] = useState('');

        const handleSubmit = async (e) => {
          e.preventDefault();
          setFormError('');

          if (!storeDb.trim() || !storeUser.trim() || !storePass.trim()) {
            setFormError('Database, user, and password are required');
            return;
          }

          const success = await onSubmit({
            store_db: storeDb.trim(),
            db_user: storeUser.trim(),
            db_pass: storePass,
            store_name: storeName.trim() || undefined,
            privilege_level: privilegeLevel,
          });

          if (success) {
            setStoreDb('');
            setStoreUser('');
            setStorePass('');
            setStoreName('');
            setPrivilegeLevel('read_write');
          }
        };

        return (
          <form className="bg-card text-card-foreground border border-border rounded-lg p-8 shadow-sm hover:shadow-md transition-shadow mt-6" onSubmit={handleSubmit}>
            <div className="flex items-center justify-between mb-6 pb-4 border-b border-border">
              <div>
                <div className="text-xl font-semibold text-foreground">Add Store to {user?.email || 'User'}</div>
                <div className="text-sm text-muted-foreground mt-1">Assign a new store database to this user</div>
              </div>
            </div>
            {formError && (
              <div className="relative w-full rounded-lg border border-destructive/50 bg-destructive/10 p-4 text-sm text-destructive mb-6">
                {formError}
              </div>
            )}
            
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
              <div>
                <Label>Store database *</Label>
                <Input
                  type="text"
                  value={storeDb}
                  onChange={(e) => setStoreDb(e.target.value)}
                  placeholder="spirits_6885"
                  disabled={isSubmitting}
                />
              </div>
              <div>
                <Label>DB user *</Label>
                <Input
                  type="text"
                  value={storeUser}
                  onChange={(e) => setStoreUser(e.target.value)}
                  placeholder="store_user"
                  disabled={isSubmitting}
                />
              </div>
              <div>
                <Label>DB password *</Label>
                <Input
                  type="password"
                  value={storePass}
                  onChange={(e) => setStorePass(e.target.value)}
                  placeholder="secret"
                  disabled={isSubmitting}
                />
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div>
                <Label>Store name</Label>
                <Input
                  type="text"
                  value={storeName}
                  onChange={(e) => setStoreName(e.target.value)}
                  placeholder="Downtown Spirits"
                  disabled={isSubmitting}
                />
              </div>
              <div>
                <Label>Privilege level</Label>
                <Select
                  value={privilegeLevel}
                  onChange={(e) => setPrivilegeLevel(e.target.value)}
                  disabled={isSubmitting}
                >
                  <option value="read_only">Read Only (SELECT)</option>
                  <option value="read_write">Read/Write (SELECT, INSERT, UPDATE, DELETE)</option>
                  <option value="full_access">Full Access (All privileges)</option>
                </Select>
                <p className="text-xs text-muted-foreground mt-1">
                  {privilegeLevel === 'read_only' && 'User can only read data'}
                  {privilegeLevel === 'read_write' && 'User can read and modify data'}
                  {privilegeLevel === 'full_access' && 'User has full database access including schema changes'}
                </p>
              </div>
            </div>

            <div className="flex gap-3">
              <Button type="submit" variant="default" disabled={isSubmitting}>
                {isSubmitting ? 'Adding...' : 'Add store'}
              </Button>
            </div>
          </form>
        );
      };

      const AddStoreFormWrapper = ({ user, onSubmit, isSubmitting, userId }) => {
        const handleSubmit = async (payload) => {
          return await onSubmit(userId, payload);
        };
        
        return <AddStoreForm user={user} onSubmit={handleSubmit} isSubmitting={isSubmitting} userId={userId} />;
      };

      const StoreAssignments = ({ user, onRemoveStore, isProcessing }) => {
        if (!user?.stores?.length) {
          return <div className="text-center py-12 text-muted-foreground text-sm">No store assignments yet.</div>;
        }

        return (
          <div className="border border-border rounded-md overflow-hidden max-h-[500px] overflow-y-auto">
            {user.stores.map((store) => {
              const identifier = getStoreIdentifier(store) || store.id || store.store_db;
              return (
                <div className="p-5 border-b border-border last:border-b-0 flex items-center justify-between gap-4 hover:bg-accent/50 transition-colors" key={`${user.id}-${identifier}`}>
                  <div className="flex-1 min-w-0">
                    <div className="font-semibold text-foreground mb-1 flex items-center gap-2 flex-wrap">
                      {store.store_name || store.store_db || 'Store'} {getPrivilegeBadge(store.privilege_level)}
                    </div>
                    <div className="text-sm text-muted-foreground flex gap-4 flex-wrap">
                      <span>DB: {store.store_db || '—'}</span>
                      {store.db_user && <span>User: {store.db_user}</span>}
                    </div>
                  </div>
                  <Button
                    type="button"
                    variant="destructive"
                    onClick={() => onRemoveStore(user.id, identifier)}
                    disabled={isProcessing}
                  >
                    Remove
                  </Button>
                </div>
              );
            })}
          </div>
        );
      };

      const UserList = ({ users, selectedUserId, onSelectUser }) => {
        if (!users?.length) {
          return <div className="text-center py-12 text-muted-foreground text-sm">No users found yet.</div>;
        }

        return (
          <div className="border border-border rounded-md overflow-hidden max-h-[500px] overflow-y-auto">
            {users.map((user) => (
              <div
                key={user.id}
                className={`p-5 border-b border-border last:border-b-0 cursor-pointer transition-colors ${
                  selectedUserId === user.id ? 'bg-primary/10' : 'hover:bg-accent/50'
                }`}
                onClick={() => onSelectUser(user.id)}
              >
                <div className="flex-1 min-w-0">
                  <div className="font-semibold text-foreground mb-1">{user.email}</div>
                  <div className="text-sm text-muted-foreground flex gap-4 flex-wrap">
                    <span>{user.full_name || '—'}</span>
                    <span>Role: {formatRole(user.user_role)}</span>
                    <span>{(user.stores?.length || 0)} store{(user.stores?.length === 1 ? '' : 's')}</span>
                  </div>
                </div>
              </div>
            ))}
          </div>
        );
      };

      const AdminPanel = ({
        users,
        selectedUserId,
        onSelectUser,
        onRefresh,
        onCreateUser,
        onAddStore,
        onRemoveStore,
        onEnsureStore,
        isLoading,
        isProcessing,
        error,
        message,
      }) => {
        const selectedUser = users.find((user) => user.id === selectedUserId) || users[0] || null;

        const knownStores = useMemo(() => {
          const map = new Map();
          (users || []).forEach((u) => {
            (u.stores || []).forEach((s) => {
              const id = getStoreIdentifier(s) || s.id || s.store_db;
              if (!id) return;
              if (!map.has(id)) {
                map.set(id, {
                  id,
                  label: s.store_name || s.store_db || String(id),
                  store_db: s.store_db || String(id),
                  store_name: s.store_name || undefined,
                });
              }
            });
          });
          return Array.from(map.values()).sort((a, b) => a.label.localeCompare(b.label));
        }, [users]);

        useEffect(() => {
          if (!selectedUser && users.length) {
            onSelectUser(users[0].id);
          }
        }, [users, selectedUser, onSelectUser]);

        return (
          <>
            <div className="bg-card border-b border-border shadow-sm">
              <div className="max-w-[1600px] mx-auto px-8 py-6 flex items-center justify-between gap-8">
                <div className="flex items-center gap-4">
                  <h1 className="text-2xl font-semibold text-foreground">Admin Panel</h1>
                </div>
                <div className="flex items-center gap-4">
                  <Button variant="secondary" onClick={onRefresh} disabled={isLoading || isProcessing}>
                    Refresh
                  </Button>
                  <Button variant="secondary" onClick={() => {
                    clearSession();
                    window.location.href = '/login.html';
                  }}>
                    Sign out
                  </Button>
                </div>
              </div>
            </div>

            <div className="max-w-[1600px] mx-auto p-8">
              {error && (
                <div className="relative w-full rounded-lg border border-destructive/50 bg-destructive/10 p-4 text-sm text-destructive mb-6">
                  {error}
                </div>
              )}
              {message && (
                <div className="relative w-full rounded-lg border border-green-200 bg-green-50 p-4 text-sm text-green-800 mb-6">
                  {message}
                </div>
              )}

              <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8 mb-8">
                <div className="bg-card text-card-foreground border border-border rounded-lg p-8 shadow-sm hover:shadow-md transition-shadow">
                  <div className="flex items-center justify-between mb-6 pb-4 border-b border-border">
                    <div>
                      <div className="text-xl font-semibold text-foreground">Users</div>
                      <div className="text-sm text-muted-foreground mt-1">Manage dashboard accounts</div>
                    </div>
                  </div>
                  {isLoading ? (
                    <div className="text-center py-12 text-muted-foreground text-sm">Loading users...</div>
                  ) : (
                    <UserList users={users} selectedUserId={selectedUser?.id} onSelectUser={onSelectUser} />
                  )}
                </div>

                <div className="bg-card text-card-foreground border border-border rounded-lg p-8 shadow-sm hover:shadow-md transition-shadow">
                  <div className="flex items-center justify-between mb-6 pb-4 border-b border-border">
                    <div>
                      <div className="text-xl font-semibold text-foreground">Store Assignments</div>
                      <div className="text-sm text-muted-foreground mt-1">
                        {selectedUser ? `${selectedUser.email} - ${selectedUser.stores?.length || 0} store(s)` : 'Select a user'}
                      </div>
                    </div>
                  </div>
                  {selectedUser ? (
                    <>
                      <StoreAssignments
                        user={selectedUser}
                        onRemoveStore={onRemoveStore}
                        isProcessing={isProcessing}
                      />
                      <AddStoreFormWrapper user={selectedUser} onSubmit={onAddStore} isSubmitting={isProcessing} userId={selectedUser.id} />
                    </>
                  ) : (
                    <div className="text-center py-12 text-muted-foreground text-sm">Select a user to manage their stores.</div>
                  )}
                </div>

                <CreateUserForm
                  onSubmit={onCreateUser}
                  isSubmitting={isProcessing}
                  knownStores={knownStores}
                  onEnsureStore={onEnsureStore}
                />
              </div>
            </div>
          </>
        );
      };

      const AdminView = ({ hasKey, users, selectedUserId, onSelectUser, onRefresh, onCreateUser, onAddStore, onRemoveStore, onEnsureStore, isLoading, isProcessing, error, message }) => {
        if (!hasKey) {
          return (
            <div className="max-w-[1600px] mx-auto p-8">
              <div className="bg-card text-card-foreground border border-border rounded-lg p-8 shadow-sm">
                <div className="flex items-center justify-between mb-6 pb-4 border-b border-border">
                  <div className="text-xl font-semibold text-foreground">Admin access unavailable</div>
                </div>
                {error && (
                  <div className="relative w-full rounded-lg border border-destructive/50 bg-destructive/10 p-4 text-sm text-destructive mb-6">
                    {error}
                  </div>
                )}
                <p className="text-muted-foreground">
                  Configure the <code className="px-1.5 py-0.5 bg-muted rounded text-sm">ADMIN_API_KEY</code> environment variable on the server to enable admin tools.
                </p>
              </div>
            </div>
          );
        }

        return (
          <AdminPanel
            users={users}
            selectedUserId={selectedUserId}
            onSelectUser={onSelectUser}
            onRefresh={onRefresh}
            onCreateUser={onCreateUser}
            onAddStore={onAddStore}
            onRemoveStore={onRemoveStore}
            onEnsureStore={onEnsureStore}
            isLoading={isLoading}
            isProcessing={isProcessing}
            error={error}
            message={message}
          />
        );
      };

      // Main App
      const App = () => {
        const [token, setToken] = useState(() => storage.get(STORAGE_KEYS.token, null));
        const [adminKey, setAdminKey] = useState(() => storage.get(STORAGE_KEYS.adminKey, ''));
        const [adminUsers, setAdminUsers] = useState([]);
        const [selectedAdminUserId, setSelectedAdminUserId] = useState(null);
        const [adminError, setAdminError] = useState('');
        const [adminMessage, setAdminMessage] = useState('');
        const [isAdminLoading, setIsAdminLoading] = useState(false);
        const [isAdminProcessing, setIsAdminProcessing] = useState(false);

        // Check authentication and redirect if needed
        React.useEffect(() => {
          if (!token) {
            window.location.href = '/login.html';
            return;
          }

          // Check if user is admin
          const payload = decodeToken(token);
          if (payload && payload.role !== 'admin') {
            // Not an admin, redirect to dashboard
            window.location.href = '/dashboard.html';
            return;
          }
        }, [token]);

        const loadAdminUsers = useCallback(async (key) => {
          if (!key) {
            setAdminUsers([]);
            setSelectedAdminUserId(null);
            return [];
          }
          setIsAdminLoading(true);
          try {
            const response = await fetch(`${API_BASE}/admin/users`, {
              headers: { 'X-Admin-Key': key },
            });
            const data = await response.json();
            if (!response.ok) {
              throw new Error(data.detail || 'Unable to load admin data');
            }
            const users = data.users || [];
            setAdminUsers(users);
            if (!users.length) {
              setSelectedAdminUserId(null);
            } else if (!selectedAdminUserId || !users.some((u) => u.id === selectedAdminUserId)) {
              setSelectedAdminUserId(users[0].id);
            }
            return users;
          } catch (error) {
            setAdminUsers([]);
            setSelectedAdminUserId(null);
            throw error;
          } finally {
            setIsAdminLoading(false);
          }
        }, [selectedAdminUserId]);

        useEffect(() => {
          if (adminKey) {
            loadAdminUsers(adminKey).catch((error) => {
              setAdminError(error.message || 'Unable to load admin data');
            });
          }
        }, [adminKey, loadAdminUsers]);

        const handleAdminRefresh = useCallback(() => {
          if (!adminKey) return;
          setAdminError('');
          loadAdminUsers(adminKey).catch((error) => {
            setAdminError(error.message || 'Unable to refresh admin data');
          });
        }, [adminKey, loadAdminUsers]);

        const handleAdminCreateUser = useCallback(async (payload) => {
          if (!adminKey) {
            setAdminError('Admin session not active');
            return false;
          }
          setIsAdminProcessing(true);
          setAdminError('');
          setAdminMessage('');
          try {
            const response = await fetch(`${API_BASE}/admin/users`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Admin-Key': adminKey,
              },
              body: JSON.stringify(payload),
            });
            const data = await response.json();
            if (!response.ok) {
              throw new Error(data.detail || 'Failed to create user');
            }
            const users = await loadAdminUsers(adminKey);
            const newUser = users.find((u) => u.id === data.id);
            if (newUser) {
              setSelectedAdminUserId(newUser.id);
            }
            setAdminMessage('User created successfully');
            return true;
          } catch (error) {
            setAdminError(error.message || 'Failed to create user');
            return false;
          } finally {
            setIsAdminProcessing(false);
          }
        }, [adminKey, loadAdminUsers]);

        const handleAdminEnsureStore = useCallback(async ({ store_db, db_user, db_pass, privilege_level }) => {
          if (!adminKey) {
            setAdminError('Admin session not active');
            return false;
          }
          setIsAdminProcessing(true);
          setAdminError('');
          setAdminMessage('');
          try {
            const response = await fetch(`${API_BASE}/admin/stores/provision`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Admin-Key': adminKey,
              },
              body: JSON.stringify({ store_db, db_user, db_pass, privilege_level: privilege_level || 'read_write' }),
            });
            const data = await response.json();
            if (!response.ok) {
              throw new Error(data.detail || 'Failed to provision database');
            }
            setAdminMessage('Database ensured successfully');
            return true;
          } catch (error) {
            setAdminError(error.message || 'Failed to provision database');
            return false;
          } finally {
            setIsAdminProcessing(false);
          }
        }, [adminKey]);

        const handleAdminAddStore = useCallback(async (userId, payload) => {
          if (!adminKey) {
            setAdminError('Admin session not active');
            return false;
          }
          setIsAdminProcessing(true);
          setAdminError('');
          setAdminMessage('');
          try {
            const response = await fetch(`${API_BASE}/admin/users/${userId}/stores`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Admin-Key': adminKey,
              },
              body: JSON.stringify(payload),
            });
            const data = await response.json();
            if (!response.ok) {
              throw new Error(data.detail || 'Failed to add store');
            }
            await loadAdminUsers(adminKey);
            setSelectedAdminUserId(userId);
            setAdminMessage('Store added successfully');
            return true;
          } catch (error) {
            setAdminError(error.message || 'Failed to add store');
            return false;
          } finally {
            setIsAdminProcessing(false);
          }
        }, [adminKey, loadAdminUsers]);

        const handleAdminRemoveStore = useCallback(async (userId, identifier) => {
          if (!adminKey) {
            setAdminError('Admin session not active');
            return;
          }
          setIsAdminProcessing(true);
          setAdminError('');
          setAdminMessage('');
          try {
            const response = await fetch(
              `${API_BASE}/admin/users/${userId}/stores/${encodeURIComponent(identifier)}`,
              {
                method: 'DELETE',
                headers: { 'X-Admin-Key': adminKey },
              }
            );
            const data = await response.json();
            if (!response.ok) {
              throw new Error(data.detail || 'Failed to remove store');
            }
            await loadAdminUsers(adminKey);
            setSelectedAdminUserId(userId);
            setAdminMessage('Store removed successfully');
          } catch (error) {
            setAdminError(error.message || 'Failed to remove store');
          } finally {
            setIsAdminProcessing(false);
          }
        }, [adminKey, loadAdminUsers]);

        // Show nothing while redirecting
        if (!token) {
          return null;
        }

        // Check if user is admin
        const payload = decodeToken(token);
        if (payload && payload.role !== 'admin') {
          return null; // Will redirect
        }

        return (
          <AdminView
            hasKey={Boolean(adminKey)}
            users={adminUsers}
            selectedUserId={selectedAdminUserId}
            onSelectUser={setSelectedAdminUserId}
            onRefresh={handleAdminRefresh}
            onCreateUser={handleAdminCreateUser}
            onAddStore={handleAdminAddStore}
            onRemoveStore={handleAdminRemoveStore}
            onEnsureStore={handleAdminEnsureStore}
            isLoading={isAdminLoading}
            isProcessing={isAdminProcessing}
            error={adminError}
            message={adminMessage}
          />
        );
      };

      // Store app component for rendering after components load
      window.renderAdminApp = function() {
        if (typeof Button === 'undefined' || typeof Input === 'undefined') {
          console.error('Components not loaded. Waiting...');
          setTimeout(window.renderAdminApp, 100);
          return;
        }
        ReactDOM.render(<App />, document.getElementById('root'));
      };
    </script>
    <script>
      // Render app after components are loaded
      (function() {
        function tryRender() {
          if (window.componentsLoaded && typeof Button !== 'undefined') {
            if (window.renderAdminApp) {
              window.renderAdminApp();
            }
          } else {
            setTimeout(tryRender, 50);
          }
        }
        
        // Listen for components loaded event
        window.addEventListener('componentsLoaded', function() {
          if (window.renderAdminApp) {
            window.renderAdminApp();
          }
        });
        
        // Also try periodically (fallback)
        tryRender();
      })();
    </script>
    <script>
      // Version check to force reload of cached pages
      (function() {
        const CURRENT_VERSION = '3.0.6';
        const VERSION_KEY = 'store-insights-html-version';
        const storedVersion = localStorage.getItem(VERSION_KEY);
        
        if (storedVersion !== CURRENT_VERSION) {
          // Clear all cached data and force reload
          localStorage.setItem(VERSION_KEY, CURRENT_VERSION);
          // Force a hard reload to bypass cache
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
              for(let registration of registrations) {
                registration.unregister();
              }
            });
          }
          // Use location.reload(true) for older browsers, or location.replace for newer
          if (window.location.search.indexOf('nocache') === -1) {
            window.location.replace(window.location.href + (window.location.search ? '&' : '?') + 'nocache=' + Date.now());
          }
        }
      })();
    </script>
  </body>
</html>