<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Login to Store Insights" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Store Insights - Login</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        --bg-primary: #f8fafc;
        --bg-secondary: #ffffff;
        --border: #e2e8f0;
        --text-primary: #0f172a;
        --text-secondary: #64748b;
        --primary: #2563eb;
        --primary-hover: #1d4ed8;
        --primary-light: #dbeafe;
        --danger: #ef4444;
        --danger-light: #fee2e2;
        --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        --radius: 0.5rem;
        --radius-lg: 0.75rem;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(19, 78, 110, 0.95));
        color: var(--text-primary);
        font-size: 14px;
        line-height: 1.5;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        position: relative;
        overflow: hidden;
      }

      body::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
          radial-gradient(circle at 20% 50%, rgba(14, 165, 233, 0.15) 0%, transparent 50%),
          radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 50%);
        pointer-events: none;
      }

      .login-container {
        width: 100%;
        max-width: 480px;
        position: relative;
        z-index: 1;
      }

      .login-card {
        width: 100%;
        background: rgba(15, 23, 42, 0.85);
        backdrop-filter: blur(16px);
        color: #fff;
        border-radius: 1.75rem;
        padding: clamp(2rem, 5vw, 3rem);
        display: grid;
        gap: 2rem;
        box-shadow: 0 40px 80px rgba(15, 23, 42, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.12);
      }

      .login-card h1 {
        margin: 0;
        text-align: center;
        font-size: clamp(2rem, 5vw, 2.5rem);
        font-weight: 700;
        background: linear-gradient(135deg, #fff 0%, rgba(148, 163, 184, 0.9) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -0.02em;
      }

      .login-card p {
        margin: 0;
        text-align: center;
        color: rgba(226, 232, 240, 0.75);
        font-size: 0.95rem;
      }

      .login-options {
        display: grid;
        gap: 1rem;
      }

      .login-option-btn {
        padding: 1.25rem 1.5rem;
        border-radius: 1rem;
        border: 2px solid rgba(148, 163, 184, 0.2);
        background: rgba(15, 23, 42, 0.6);
        color: #fff;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        position: relative;
        overflow: hidden;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
        user-select: none;
        -webkit-user-select: none;
        min-height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .login-option-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transition: left 0.5s ease;
      }

      .login-option-btn:hover::before {
        left: 100%;
      }

      .login-option-btn:hover {
        border-color: rgba(14, 165, 233, 0.5);
        background: rgba(14, 165, 233, 0.1);
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(14, 165, 233, 0.2);
      }

      .login-option-btn:active {
        transform: translateY(0);
        background: rgba(14, 165, 233, 0.2);
      }

      .mobility-form {
        display: grid;
        gap: 1.25rem;
        margin-top: 0.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid rgba(148, 163, 184, 0.2);
      }

      .mobility-form label {
        display: grid;
        gap: 0.5rem;
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.9rem;
        font-weight: 500;
      }

      .mobility-form-row {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1rem;
      }

      .mobility-form input {
        background: rgba(15, 23, 42, 0.7);
        border: 1px solid rgba(148, 163, 184, 0.3);
        color: #fff;
        padding: 0.85rem 1rem;
        border-radius: 0.75rem;
        font-size: 0.95rem;
        transition: all 0.2s ease;
      }

      .mobility-form input:focus {
        outline: none;
        border-color: rgba(14, 165, 233, 0.6);
        background: rgba(15, 23, 42, 0.85);
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
      }

      .mobility-form input:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .mobility-form input.readonly-input {
        background: rgba(15, 23, 42, 0.5);
        color: rgba(226, 232, 240, 0.7);
        border-color: rgba(148, 163, 184, 0.2);
        cursor: default;
      }

      .mobility-form input[readonly] {
        background: rgba(15, 23, 42, 0.5);
        color: rgba(226, 232, 240, 0.7);
        border-color: rgba(148, 163, 184, 0.2);
        cursor: default;
      }

      .mobility-form input::placeholder {
        color: rgba(226, 232, 240, 0.5);
      }

      .edit-btn {
        padding: 0.6rem 1rem;
        border-radius: 0.6rem;
        border: 1px solid rgba(148, 163, 184, 0.3);
        background: rgba(15, 23, 42, 0.6);
        color: rgba(255, 255, 255, 0.9);
        font-weight: 500;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
        width: 100%;
        margin-top: 0.5rem;
      }

      .edit-btn:hover:not(:disabled) {
        background: rgba(15, 23, 42, 0.8);
        border-color: rgba(148, 163, 184, 0.5);
      }

      .edit-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .countdown-message {
        text-align: center;
        color: rgba(226, 232, 240, 0.8);
        font-size: 0.95rem;
        padding: 0.75rem;
        background: rgba(14, 165, 233, 0.1);
        border-radius: 0.75rem;
        margin: 0.5rem 0;
      }

      .mobility-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
        margin-top: 0.5rem;
      }

      .mobility-actions button {
        padding: 0.85rem 1.25rem;
        border-radius: 0.75rem;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.95rem;
      }

      .mobility-actions button.primary {
        background: var(--primary);
        color: #fff;
      }

      .mobility-actions button.primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 20px rgba(14, 165, 233, 0.3);
      }

      .mobility-actions button.secondary {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.3);
        color: rgba(255, 255, 255, 0.9);
      }

      .mobility-actions button.secondary:hover {
        background: rgba(15, 23, 42, 0.8);
        border-color: rgba(148, 163, 184, 0.5);
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      label {
        display: block;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
      }

      .login-card label {
        color: rgba(255, 255, 255, 0.9);
      }

      .login-card input {
        background: rgba(15, 23, 42, 0.65);
        border: 1px solid rgba(148, 163, 184, 0.25);
        color: #fff;
        padding: 0.8rem 1rem;
        border-radius: 0.9rem;
        transition: all 0.2s ease;
        width: 100%;
        font-size: 0.95rem;
      }

      .login-card input:focus {
        outline: none;
        border-color: rgba(14, 165, 233, 0.6);
        background: rgba(15, 23, 42, 0.85);
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
      }

      .login-card input::placeholder {
        color: rgba(226, 232, 240, 0.6);
      }

      .login-card button {
        padding: 0.85rem 1.25rem;
        border-radius: 0.95rem;
        border: none;
        font-weight: 600;
        cursor: pointer;
        background: var(--primary);
        color: #fff;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        width: 100%;
      }

      .login-card button:hover,
      .login-card button:focus {
        outline: none;
        transform: translateY(-1px);
        box-shadow: 0 12px 28px rgba(14, 165, 233, 0.35);
      }

      .login-card button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .login-card button.secondary {
        background: rgba(15, 23, 42, 0.55);
        border: 1px solid rgba(148, 163, 184, 0.35);
      }

      .error-message {
        padding: 0.9rem 1.1rem;
        border-radius: 0.95rem;
        background: rgba(220, 38, 38, 0.18);
        color: #fecaca;
        font-weight: 600;
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script>
      // Version check to force reload of cached pages
      (function() {
        const CURRENT_VERSION = '2.0.2';
        const VERSION_KEY = 'store-insights-html-version';
        const storedVersion = localStorage.getItem(VERSION_KEY);
        
        if (storedVersion !== CURRENT_VERSION) {
          // Clear all cached data and force reload
          localStorage.setItem(VERSION_KEY, CURRENT_VERSION);
          // Force a hard reload to bypass cache
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
              for(let registration of registrations) {
                registration.unregister();
              }
            });
          }
          // Use location.reload(true) for older browsers, or location.replace for newer
          if (window.location.search.indexOf('nocache') === -1) {
            window.location.replace(window.location.href + (window.location.search ? '&' : '?') + 'nocache=' + Date.now());
          }
        }
      })();
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      const API_BASE = window.location.origin;

      // Storage helper
      const storage = {
        get: (key, defaultValue) => {
          try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : defaultValue;
          } catch {
            return defaultValue;
          }
        },
        set: (key, value) => {
          try {
            localStorage.setItem(key, JSON.stringify(value));
          } catch {}
        },
        remove: (key) => {
          try {
            localStorage.removeItem(key);
          } catch {}
        },
      };

      const STORAGE_KEYS = {
        token: 'store-insights/token',
        adminKey: 'store-insights/admin-key',
        role: 'store-insights/role',
        profile: 'store-insights/profile',
        stores: 'store-insights/stores',
        selectedStore: 'store-insights/selected-store',
      };

      const LoginForm = ({ onSubmit, isLoading, error }) => {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');

        const submit = (event) => {
          event.preventDefault();
          onSubmit({ email, password });
        };

        return (
          <form onSubmit={submit}>
            <label htmlFor="email">
              Email
              <input
                id="email"
                type="email"
                placeholder="you@example.com"
                value={email}
                onChange={(event) => setEmail(event.target.value)}
                required
                disabled={isLoading}
              />
            </label>
            <label htmlFor="password">
              Password
              <input
                id="password"
                type="password"
                placeholder="••••••••"
                value={password}
                onChange={(event) => setPassword(event.target.value)}
                required
                disabled={isLoading}
              />
            </label>
            {error ? <div className="error-message">{error}</div> : null}
            <button type="submit" disabled={isLoading}>
              {isLoading ? 'Signing in…' : 'Sign in'}
            </button>
          </form>
        );
      };

      const LoginSelection = ({ onSelectInsights, onSelectMobility }) => {
        const handleInsightsClick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          onSelectInsights();
        };

        const handleMobilityClick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          onSelectMobility();
        };

        return (
          <div className="login-options">
            <button
              type="button"
              className="login-option-btn"
              onClick={handleInsightsClick}
              onTouchStart={(e) => {
                e.currentTarget.style.transform = 'scale(0.98)';
              }}
              onTouchEnd={(e) => {
                e.currentTarget.style.transform = '';
                handleInsightsClick(e);
              }}
            >
              Login to Spirits Insights
            </button>
            <button
              type="button"
              className="login-option-btn"
              onClick={handleMobilityClick}
              onTouchStart={(e) => {
                e.currentTarget.style.transform = 'scale(0.98)';
              }}
              onTouchEnd={(e) => {
                e.currentTarget.style.transform = '';
                handleMobilityClick(e);
              }}
            >
              Login to Spirits Mobility
            </button>
          </div>
        );
      };

      const MobilityConnectionForm = ({ onConnect, onBack, isLoading, error }) => {
        const savedIp = localStorage.getItem('spirits_mobility_ip');
        const savedPort = localStorage.getItem('spirits_mobility_port');
        const hasSavedConnection = Boolean(savedIp && savedPort);
        
        const [serverIp, setServerIp] = useState(savedIp || '');
        const [serverPort, setServerPort] = useState(savedPort || '8080');
        const [isEditing, setIsEditing] = useState(!hasSavedConnection);
        const [countdown, setCountdown] = useState(hasSavedConnection ? 12 : null);
        const [isConnecting, setIsConnecting] = useState(false);

        useEffect(() => {
          if (hasSavedConnection && !isEditing && countdown !== null && countdown > 0) {
            const timer = setTimeout(() => {
              setCountdown(countdown - 1);
            }, 1000);
            return () => clearTimeout(timer);
          } else if (hasSavedConnection && !isEditing && countdown === 0 && !isConnecting) {
            setIsConnecting(true);
            onConnect(serverIp, serverPort);
          }
        }, [countdown, hasSavedConnection, isEditing, isConnecting, serverIp, serverPort, onConnect]);

        const handleEdit = () => {
          setIsEditing(true);
          setCountdown(null);
        };

        const handleConnect = (event) => {
          event?.preventDefault();
          if (serverIp && serverPort) {
            setIsConnecting(true);
            localStorage.setItem('spirits_mobility_ip', serverIp);
            localStorage.setItem('spirits_mobility_port', serverPort);
            onConnect(serverIp, serverPort);
          }
        };

        return (
          <div className="mobility-form">
            <h2 style={{ margin: '0 0 1rem 0', textAlign: 'center', fontSize: '1.25rem', fontWeight: 600 }}>
              Logging into Spirits Mobility
            </h2>
            <form onSubmit={handleConnect}>
              <label htmlFor="server-ip">
                Server IP Address
                <input
                  id="server-ip"
                  type="text"
                  placeholder="192.168.1.100"
                  value={serverIp}
                  onChange={(event) => setServerIp(event.target.value)}
                  required
                  disabled={!isEditing || isConnecting}
                  readOnly={!isEditing}
                  className={!isEditing ? 'readonly-input' : ''}
                  pattern={isEditing ? "^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$|^[a-zA-Z0-9]([a-zA-Z0-9\\-]{0,61}[a-zA-Z0-9])?(\\.[a-zA-Z0-9]([a-zA-Z0-9\\-]{0,61}[a-zA-Z0-9])?)*$" : undefined}
                  title={isEditing ? "Enter a valid IP address or hostname" : undefined}
                />
              </label>
              <div className="mobility-form-row">
                <label htmlFor="server-port">
                  Port
                  <input
                    id="server-port"
                    type="number"
                    placeholder="8080"
                    value={serverPort}
                    onChange={(event) => setServerPort(event.target.value)}
                    required
                    min="1"
                    max="65535"
                    disabled={!isEditing || isConnecting}
                    readOnly={!isEditing}
                    className={!isEditing ? 'readonly-input' : ''}
                  />
                </label>
              </div>
              {!isEditing && hasSavedConnection && (
                <button
                  type="button"
                  className="edit-btn"
                  onClick={handleEdit}
                  disabled={isConnecting}
                >
                  Edit
                </button>
              )}
              {error ? <div className="error-message">{error}</div> : null}
              {!isEditing && hasSavedConnection && countdown !== null && (
                <div className="countdown-message">
                  Redirecting in {countdown} second{countdown !== 1 ? 's' : ''}...
                </div>
              )}
              <div className="mobility-actions">
                <button type="button" className="secondary" onClick={onBack} disabled={isConnecting}>
                  Back
                </button>
                {isEditing ? (
                  <button type="submit" className="primary" disabled={isConnecting || !serverIp || !serverPort}>
                    {isConnecting ? 'Connecting…' : 'Connect'}
                  </button>
                ) : (
                  <button type="button" className="primary" onClick={handleConnect} disabled={isConnecting}>
                    {isConnecting ? 'Connecting…' : 'Continue'}
                  </button>
                )}
              </div>
            </form>
          </div>
        );
      };

      const LoginApp = () => {
        // Always start with selection view - force it to prevent caching issues
        const [loginView, setLoginView] = useState(() => {
          // Clear any old state that might be cached
          return 'selection';
        });
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState('');
        const [isConnectingMobility, setIsConnectingMobility] = useState(false);
        const [mobilityError, setMobilityError] = useState('');

        // Ensure we always show selection screen on mount
        useEffect(() => {
          setLoginView('selection');
        }, []);

        const handleLogin = async ({ email, password }) => {
          setIsLoading(true);
          setError('');

          try {
            const response = await fetch(`${API_BASE}/auth/login`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, password }),
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.detail || 'Login failed');
            }

            // Store all login data in localStorage before redirecting
            storage.set(STORAGE_KEYS.token, data.token);
            
            // Store role
            if (data.role) {
              storage.set(STORAGE_KEYS.role, data.role);
            }
            
            // Store profile
            if (data.email || data.full_name) {
              storage.set(STORAGE_KEYS.profile, {
                email: data.email || '',
                full_name: data.full_name || '',
              });
            }
            
            // Store stores and set initial selectedStore
            if (data.stores && Array.isArray(data.stores) && data.stores.length > 0) {
              storage.set(STORAGE_KEYS.stores, data.stores);
              // Helper to get store identifier (same logic as dashboard)
              const getStoreIdentifier = (store) => {
                if (!store) return '';
                if (store.store_id !== undefined && store.store_id !== null) {
                  return String(store.store_id);
                }
                if (store.store_db) {
                  return String(store.store_db);
                }
                if (store.store_name) {
                  return String(store.store_name);
                }
                if (store.id) {
                  return String(store.id);
                }
                return '';
              };
              
              // Set first store as selected (or restore from localStorage if available)
              const savedStore = storage.get(STORAGE_KEYS.selectedStore, null);
              let initialStore = null;
              if (savedStore) {
                // Try to find matching store using identifier
                const savedIdentifier = getStoreIdentifier(savedStore);
                if (savedIdentifier) {
                  const match = data.stores.find((s) => {
                    const sIdentifier = getStoreIdentifier(s);
                    return sIdentifier && savedIdentifier && sIdentifier === savedIdentifier;
                  });
                  if (match) {
                    initialStore = match;
                  }
                }
              }
              if (!initialStore) {
                initialStore = data.stores[0];
              }
              storage.set(STORAGE_KEYS.selectedStore, initialStore);
            } else {
              // No stores, clear any old store data
              storage.remove(STORAGE_KEYS.stores);
              storage.remove(STORAGE_KEYS.selectedStore);
            }
            
            // Store admin key if present
            if (data.admin_key) {
              storage.set(STORAGE_KEYS.adminKey, data.admin_key);
            } else {
              storage.remove(STORAGE_KEYS.adminKey);
            }

            // Redirect based on role
            // Admin users go directly to admin panel, others go to dashboard
            const role = data.role || 'owner';
            if (role === 'admin') {
              window.location.href = '/admin.html';
            } else {
              window.location.href = '/dashboard.html';
            }
          } catch (err) {
            setError(err.message || 'Login failed. Please check your credentials.');
          } finally {
            setIsLoading(false);
          }
        };

        const handleMobilityConnect = (ip, port) => {
          setIsConnectingMobility(true);
          setMobilityError('');
          
          const mobilityUrl = `http://${ip}:${port}/index.html`;
          
          console.log('Attempting to connect to Spirits Mobility:', mobilityUrl);
          
          // Some browsers block window.location navigation from HTTPS to HTTP
          // Use form submission as a workaround, which browsers typically allow
          setTimeout(() => {
            try {
              console.log('Redirecting to:', mobilityUrl);
              
              // Create a temporary form and submit it to navigate to HTTP URL
              // This bypasses browser restrictions on HTTPS->HTTP navigation
              const form = document.createElement('form');
              form.method = 'GET';
              form.action = mobilityUrl;
              form.style.display = 'none';
              document.body.appendChild(form);
              form.submit();
            } catch (error) {
              console.error('Redirect failed:', error);
              // Fallback to window.location if form submission fails
              try {
                window.location.href = mobilityUrl;
              } catch (fallbackError) {
                console.error('Fallback redirect also failed:', fallbackError);
                setMobilityError('Failed to redirect. Please check the server address and try again.');
                setIsConnectingMobility(false);
              }
            }
          }, 300);
        };

        return (
          <div className="login-container">
            <div className="login-card">
              <h1>Spirits Store Insights</h1>
              <p>Choose your login option to continue.</p>
              {loginView === 'selection' && (
                <LoginSelection
                  onSelectInsights={() => setLoginView('insights')}
                  onSelectMobility={() => setLoginView('mobility')}
                />
              )}
              {loginView === 'insights' && (
                <>
                  <LoginForm onSubmit={handleLogin} isLoading={isLoading} error={error} />
                  <button
                    type="button"
                    className="secondary"
                    onClick={() => setLoginView('selection')}
                    style={{ marginTop: '0.5rem', width: '100%' }}
                  >
                    Back
                  </button>
                </>
              )}
              {loginView === 'mobility' && (
                <MobilityConnectionForm
                  onConnect={handleMobilityConnect}
                  onBack={() => setLoginView('selection')}
                  isLoading={isConnectingMobility}
                  error={mobilityError}
                />
              )}
            </div>
          </div>
        );
      };

      ReactDOM.render(<LoginApp />, document.getElementById('root'));
    </script>
  </body>
</html>

