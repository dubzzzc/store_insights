<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Login to Store Insights" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Store Insights - Login</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Tailwind CSS Play CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Configure Tailwind with Quilt Design System tokens
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              border: "hsl(var(--border))",
              input: "hsl(var(--input))",
              ring: "hsl(var(--ring))",
              background: "hsl(var(--background))",
              foreground: "hsl(var(--foreground))",
              primary: {
                DEFAULT: "hsl(var(--primary))",
                foreground: "hsl(var(--primary-foreground))",
              },
              secondary: {
                DEFAULT: "hsl(var(--secondary))",
                foreground: "hsl(var(--secondary-foreground))",
              },
              destructive: {
                DEFAULT: "hsl(var(--destructive))",
                foreground: "hsl(var(--destructive-foreground))",
              },
              muted: {
                DEFAULT: "hsl(var(--muted))",
                foreground: "hsl(var(--muted-foreground))",
              },
              accent: {
                DEFAULT: "hsl(var(--accent))",
                foreground: "hsl(var(--accent-foreground))",
              },
              card: {
                DEFAULT: "hsl(var(--card))",
                foreground: "hsl(var(--card-foreground))",
              },
            },
            borderRadius: {
              lg: "var(--radius)",
              md: "calc(var(--radius) - 2px)",
              sm: "calc(var(--radius) - 4px)",
            },
            fontFamily: {
              sans: ['Inter', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'sans-serif'],
            },
            spacing: {
              // 8pt grid system
              '8pt': '8px',
              '16pt': '16px',
              '24pt': '24px',
              '32pt': '32px',
              '40pt': '40px',
              '48pt': '48px',
              '56pt': '56px',
              '64pt': '64px',
            },
          },
        },
      }
    </script>
    <style>
      /* Quilt Design System - Figma Design Tokens */
      :root {
        /* Primary - Plum */
        --primary: 142 48% 45%; /* #8E548D - plum-500 */
        --primary-foreground: 0 0% 100%;
        --primary-hover: 142 48% 40%; /* plum-600 */
        
        /* Accent - Blue */
        --accent: 210 60% 70%; /* #9DBFDC - blue-400 */
        --accent-foreground: 222 47% 11%;
        
        /* Secondary - Blue shades */
        --secondary: 210 70% 85%; /* blue-200 */
        --secondary-foreground: 222 47% 11%;
        
        /* Muted - Gray */
        --muted: 0 0% 96%; /* gray-100 #F7F7F7 */
        --muted-foreground: 0 0% 44%; /* gray-500 #707070 */
        
        /* Destructive */
        --destructive: 0 84% 60%; /* #EF4444 */
        --destructive-foreground: 0 0% 100%;
        
        /* Background - Gradient */
        --background-start: 142 48% 45%; /* #8E548D */
        --background-end: 222 80% 20%; /* #081E4F */
        --background: 0 0% 100%;
        --foreground: 222 80% 10%; /* navy-800 */
        
        /* Card */
        --card: 0 0% 100%;
        --card-foreground: 222 80% 10%;
        
        /* Border & Input */
        --border: 210 60% 70%; /* blue-400 */
        --input: 210 60% 70%;
        --ring: 142 48% 45%; /* plum-500 */
        
        /* Radius */
        --radius: 0.5rem; /* rounded-lg */
      }

      * {
        border-color: hsl(var(--border));
      }

      body {
        background: linear-gradient(135deg, hsl(var(--background-start)) 0%, hsl(var(--background-end)) 100%);
        color: hsl(var(--foreground));
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        min-height: 100vh;
      }
      
      /* Shadow utilities matching Figma */
      .shadow-sm {
        box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      }
      .shadow-md {
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      }
      .shadow-lg {
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      }
    </style>
  </head>
  <body className="min-h-screen flex items-center justify-center p-8 relative overflow-hidden">
    <div id="root" className="relative z-10 w-full max-w-md mx-auto"></div>
    
    <script>
      // Version check to force reload of cached pages
      (function() {
        const CURRENT_VERSION = '3.0.1';
        const VERSION_KEY = 'store-insights-html-version';
        const storedVersion = localStorage.getItem(VERSION_KEY);
        
        if (storedVersion !== CURRENT_VERSION) {
          // Clear all cached data and force reload
          localStorage.setItem(VERSION_KEY, CURRENT_VERSION);
          // Force a hard reload to bypass cache
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
              for(let registration of registrations) {
                registration.unregister();
              }
            });
          }
          // Use location.reload(true) for older browsers, or location.replace for newer
          if (window.location.search.indexOf('nocache') === -1) {
            window.location.replace(window.location.href + (window.location.search ? '&' : '?') + 'nocache=' + Date.now());
          }
        }
      })();
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      const API_BASE = window.location.origin;

      // Storage helper
      const storage = {
        get: (key, defaultValue) => {
          try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : defaultValue;
          } catch {
            return defaultValue;
          }
        },
        set: (key, value) => {
          try {
            localStorage.setItem(key, JSON.stringify(value));
          } catch {}
        },
        remove: (key) => {
          try {
            localStorage.removeItem(key);
          } catch {}
        },
      };

      const STORAGE_KEYS = {
        token: 'store-insights/token',
        adminKey: 'store-insights/admin-key',
        role: 'store-insights/role',
        profile: 'store-insights/profile',
        stores: 'store-insights/stores',
        selectedStore: 'store-insights/selected-store',
      };

      // Reusable Components
      const Button = ({ children, variant = "default", className = "", ...props }) => {
        const baseClasses = "inline-flex items-center justify-center rounded-lg text-sm font-semibold ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 min-h-[48px] px-6 py-3";
        const variants = {
          default: "bg-primary text-primary-foreground hover:bg-[hsl(var(--primary-hover))] shadow-md hover:shadow-lg active:scale-[0.98]",
          secondary: "bg-secondary text-secondary-foreground border border-accent hover:bg-accent hover:text-accent-foreground shadow-sm",
          outline: "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
          ghost: "hover:bg-accent hover:text-accent-foreground",
        };
        return (
          <button className={`${baseClasses} ${variants[variant]} ${className}`} {...props}>
            {children}
          </button>
        );
      };

      const Input = ({ className = "", size = "default", ...props }) => {
        const sizeClasses = {
          default: "h-11 px-4 py-2.5",
          sm: "h-9 px-3 py-2 text-sm",
        };
        return (
          <input
            className={`flex w-full rounded-lg border border-input bg-background px-4 py-2.5 text-sm text-foreground ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60 transition-all shadow-sm ${sizeClasses[size]} ${className}`}
            {...props}
          />
        );
      };

      const Label = ({ children, className = "", ...props }) => (
        <label className={`text-sm font-medium leading-none text-foreground mb-2 block ${className}`} {...props}>
          {children}
        </label>
      );

      const LoginForm = ({ onSubmit, isLoading, error }) => {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');

        const submit = (event) => {
          event.preventDefault();
          onSubmit({ email, password });
        };

        return (
          <form onSubmit={submit} className="space-y-5">
            <div className="space-y-2">
              <Label htmlFor="email">Email</Label>
              <Input
                id="email"
                type="email"
                placeholder="you@example.com"
                value={email}
                onChange={(event) => setEmail(event.target.value)}
                required
                disabled={isLoading}
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="password">Password</Label>
              <Input
                id="password"
                type="password"
                placeholder="••••••••"
                value={password}
                onChange={(event) => setPassword(event.target.value)}
                required
                disabled={isLoading}
              />
            </div>
            {error && (
              <div className="rounded-lg bg-destructive/10 border border-destructive/50 p-4 text-destructive font-semibold text-sm shadow-sm">
                {error}
              </div>
            )}
            <Button type="submit" variant="default" disabled={isLoading} className="w-full">
              {isLoading ? 'Signing in…' : 'Sign in'}
            </Button>
          </form>
        );
      };

      const LoginSelection = ({ onSelectInsights, onSelectMobility }) => {
        const handleInsightsClick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          onSelectInsights();
        };

        const handleMobilityClick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          onSelectMobility();
        };

        return (
          <div className="space-y-4">
            <button
              type="button"
              className="relative w-full p-6 rounded-lg border-2 border-accent bg-card text-card-foreground font-semibold text-base cursor-pointer transition-all hover:border-primary hover:bg-primary hover:text-primary-foreground active:scale-[0.98] min-h-[48px] flex items-center justify-center touch-manipulation select-none shadow-md hover:shadow-lg"
              onClick={handleInsightsClick}
              onTouchStart={(e) => {
                e.currentTarget.style.transform = 'scale(0.98)';
              }}
              onTouchEnd={(e) => {
                e.currentTarget.style.transform = '';
                handleInsightsClick(e);
              }}
            >
              Login to Spirits Insights
            </button>
            <button
              type="button"
              className="relative w-full p-6 rounded-lg border-2 border-accent bg-card text-card-foreground font-semibold text-base cursor-pointer transition-all hover:border-primary hover:bg-primary hover:text-primary-foreground active:scale-[0.98] min-h-[48px] flex items-center justify-center touch-manipulation select-none shadow-md hover:shadow-lg"
              onClick={handleMobilityClick}
              onTouchStart={(e) => {
                e.currentTarget.style.transform = 'scale(0.98)';
              }}
              onTouchEnd={(e) => {
                e.currentTarget.style.transform = '';
                handleMobilityClick(e);
              }}
            >
              Login to Spirits Mobility
            </button>
          </div>
        );
      };

      const MobilityConnectionForm = ({ onConnect, onBack, isLoading, error }) => {
        const savedIp = localStorage.getItem('spirits_mobility_ip');
        const savedPort = localStorage.getItem('spirits_mobility_port');
        const hasSavedConnection = Boolean(savedIp && savedPort);
        
        const [serverIp, setServerIp] = useState(savedIp || '');
        const [serverPort, setServerPort] = useState(savedPort || '8080');
        const [isEditing, setIsEditing] = useState(!hasSavedConnection);
        const [countdown, setCountdown] = useState(hasSavedConnection ? 12 : null);
        const [isConnecting, setIsConnecting] = useState(false);

        useEffect(() => {
          if (hasSavedConnection && !isEditing && countdown !== null && countdown > 0) {
            const timer = setTimeout(() => {
              setCountdown(countdown - 1);
            }, 1000);
            return () => clearTimeout(timer);
          } else if (hasSavedConnection && !isEditing && countdown === 0 && !isConnecting) {
            setIsConnecting(true);
            onConnect(serverIp, serverPort);
          }
        }, [countdown, hasSavedConnection, isEditing, isConnecting, serverIp, serverPort, onConnect]);

        const handleEdit = () => {
          setIsEditing(true);
          setCountdown(null);
        };

        const handleConnect = (event) => {
          event?.preventDefault();
          if (serverIp && serverPort) {
            setIsConnecting(true);
            localStorage.setItem('spirits_mobility_ip', serverIp);
            localStorage.setItem('spirits_mobility_port', serverPort);
            onConnect(serverIp, serverPort);
          }
        };

        return (
          <div className="space-y-5 mt-2 pt-6 border-t border-border">
            <h2 className="text-center text-xl font-semibold text-foreground mb-4">
              Logging into Spirits Mobility
            </h2>
            <form onSubmit={handleConnect} className="space-y-5">
              <div className="space-y-2">
                <Label htmlFor="server-ip">Server IP Address</Label>
                <Input
                  id="server-ip"
                  type="text"
                  placeholder="192.168.1.100"
                  value={serverIp}
                  onChange={(event) => setServerIp(event.target.value)}
                  required
                  disabled={!isEditing || isConnecting}
                  readOnly={!isEditing}
                  className={!isEditing ? 'bg-muted text-muted-foreground border-muted cursor-default' : ''}
                  pattern={isEditing ? "^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$|^[a-zA-Z0-9]([a-zA-Z0-9\\-]{0,61}[a-zA-Z0-9])?(\\.[a-zA-Z0-9]([a-zA-Z0-9\\-]{0,61}[a-zA-Z0-9])?)*$" : undefined}
                  title={isEditing ? "Enter a valid IP address or hostname" : undefined}
                />
              </div>
              <div className="grid grid-cols-[2fr_1fr] gap-4">
                <div className="space-y-2">
                  <Label htmlFor="server-port">Port</Label>
                  <Input
                    id="server-port"
                    type="number"
                    placeholder="8080"
                    value={serverPort}
                    onChange={(event) => setServerPort(event.target.value)}
                    required
                    min="1"
                    max="65535"
                    disabled={!isEditing || isConnecting}
                    readOnly={!isEditing}
                    className={!isEditing ? 'bg-muted text-muted-foreground border-muted cursor-default' : ''}
                  />
                </div>
              </div>
              {!isEditing && hasSavedConnection && (
                <Button
                  type="button"
                  variant="secondary"
                  onClick={handleEdit}
                  disabled={isConnecting}
                  className="w-full mt-2"
                >
                  Edit
                </Button>
              )}
              {error && (
                <div className="rounded-lg bg-destructive/10 border border-destructive/50 p-4 text-destructive font-semibold text-sm shadow-sm">
                  {error}
                </div>
              )}
              {!isEditing && hasSavedConnection && countdown !== null && (
                <div className="text-center text-foreground text-sm py-3 px-3 bg-accent/20 rounded-lg border border-accent">
                  Redirecting in {countdown} second{countdown !== 1 ? 's' : ''}...
                </div>
              )}
              <div className="grid grid-cols-2 gap-3 mt-2">
                <Button type="button" variant="secondary" onClick={onBack} disabled={isConnecting} className="w-full">
                  Back
                </Button>
                {isEditing ? (
                  <Button type="submit" variant="default" disabled={isConnecting || !serverIp || !serverPort} className="w-full">
                    {isConnecting ? 'Connecting…' : 'Connect'}
                  </Button>
                ) : (
                  <Button type="button" variant="default" onClick={handleConnect} disabled={isConnecting} className="w-full">
                    {isConnecting ? 'Connecting…' : 'Continue'}
                  </Button>
                )}
              </div>
            </form>
          </div>
        );
      };

      const LoginApp = () => {
        // Always start with selection view - force it to prevent caching issues
        const [loginView, setLoginView] = useState(() => {
          // Clear any old state that might be cached
          return 'selection';
        });
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState('');
        const [isConnectingMobility, setIsConnectingMobility] = useState(false);
        const [mobilityError, setMobilityError] = useState('');

        // Ensure we always show selection screen on mount
        useEffect(() => {
          setLoginView('selection');
        }, []);

        const handleLogin = async ({ email, password }) => {
          setIsLoading(true);
          setError('');

          try {
            const response = await fetch(`${API_BASE}/auth/login`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, password }),
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.detail || 'Login failed');
            }

            // Store all login data in localStorage before redirecting
            storage.set(STORAGE_KEYS.token, data.token);
            
            // Store role
            if (data.role) {
              storage.set(STORAGE_KEYS.role, data.role);
            }
            
            // Store profile
            if (data.email || data.full_name) {
              storage.set(STORAGE_KEYS.profile, {
                email: data.email || '',
                full_name: data.full_name || '',
              });
            }
            
            // Store stores and set initial selectedStore
            if (data.stores && Array.isArray(data.stores) && data.stores.length > 0) {
              storage.set(STORAGE_KEYS.stores, data.stores);
              // Helper to get store identifier (same logic as dashboard)
              const getStoreIdentifier = (store) => {
                if (!store) return '';
                if (store.store_id !== undefined && store.store_id !== null) {
                  return String(store.store_id);
                }
                if (store.store_db) {
                  return String(store.store_db);
                }
                if (store.store_name) {
                  return String(store.store_name);
                }
                if (store.id) {
                  return String(store.id);
                }
                return '';
              };
              
              // Set first store as selected (or restore from localStorage if available)
              const savedStore = storage.get(STORAGE_KEYS.selectedStore, null);
              let initialStore = null;
              if (savedStore) {
                // Try to find matching store using identifier
                const savedIdentifier = getStoreIdentifier(savedStore);
                if (savedIdentifier) {
                  const match = data.stores.find((s) => {
                    const sIdentifier = getStoreIdentifier(s);
                    return sIdentifier && savedIdentifier && sIdentifier === savedIdentifier;
                  });
                  if (match) {
                    initialStore = match;
                  }
                }
              }
              if (!initialStore) {
                initialStore = data.stores[0];
              }
              storage.set(STORAGE_KEYS.selectedStore, initialStore);
            } else {
              // No stores, clear any old store data
              storage.remove(STORAGE_KEYS.stores);
              storage.remove(STORAGE_KEYS.selectedStore);
            }
            
            // Store admin key if present
            if (data.admin_key) {
              storage.set(STORAGE_KEYS.adminKey, data.admin_key);
            } else {
              storage.remove(STORAGE_KEYS.adminKey);
            }

            // Redirect based on role
            // Admin users go directly to admin panel, others go to dashboard
            const role = data.role || 'owner';
            if (role === 'admin') {
              window.location.href = '/admin.html';
            } else {
              window.location.href = '/dashboard.html';
            }
          } catch (err) {
            setError(err.message || 'Login failed. Please check your credentials.');
          } finally {
            setIsLoading(false);
          }
        };

        const handleMobilityConnect = (ip, port) => {
          setIsConnectingMobility(true);
          setMobilityError('');
          
          const mobilityUrl = `http://${ip}:${port}/index.html`;
          
          // Modern browsers block HTTPS->HTTP navigation, but we can try opening in new tab
          // which is often allowed. The user can then close the tab to return.
          // Do this immediately while we still have the user gesture context
          try {
            // Try to open in same window first
            const link = document.createElement('a');
            link.href = mobilityUrl;
            link.target = '_self';
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          } catch (error) {
            // If that fails, open in new tab (browsers usually allow this)
            console.log('Opening Spirits Mobility in new tab due to browser security restrictions');
            window.open(mobilityUrl, '_blank');
          }
        };

        return (
          <div className="w-full max-w-md mx-auto relative z-10">
            <div className="w-full bg-card text-card-foreground rounded-lg p-8 md:p-12 grid gap-8 shadow-lg border border-border">
              <div>
                <h1 className="m-0 text-center text-3xl md:text-4xl font-bold text-foreground tracking-tight">
                  Spirits Store Insights
                </h1>
                <p className="m-0 text-center text-muted-foreground text-base mt-2">
                  Choose your login option to continue.
                </p>
              </div>
              {loginView === 'selection' && (
                <LoginSelection
                  onSelectInsights={() => setLoginView('insights')}
                  onSelectMobility={() => setLoginView('mobility')}
                />
              )}
              {loginView === 'insights' && (
                <>
                  <LoginForm onSubmit={handleLogin} isLoading={isLoading} error={error} />
                  <Button
                    type="button"
                    variant="secondary"
                    onClick={() => setLoginView('selection')}
                    className="w-full mt-2"
                  >
                    Back
                  </Button>
                </>
              )}
              {loginView === 'mobility' && (
                <MobilityConnectionForm
                  onConnect={handleMobilityConnect}
                  onBack={() => setLoginView('selection')}
                  isLoading={isConnectingMobility}
                  error={mobilityError}
                />
              )}
            </div>
          </div>
        );
      };

      ReactDOM.render(<LoginApp />, document.getElementById('root'));
    </script>
  </body>
</html>