<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Login to Store Insights" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Store Insights - Login</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Tailwind CSS - Compiled -->
    <link rel="stylesheet" href="/tailwind.css">
    <style>
      /* Login page uses theme gradient background */
      body {
        background: linear-gradient(135deg, hsl(var(--color-gradient-start)) 0%, hsl(var(--color-gradient-end)) 100%);
        min-height: 100vh;
      }
      
      /* Login-specific hover state for primary button */
      :root {
        --primary-hover: var(--color-brand-primary);
      }
      
      [data-theme="quilt"] {
        --primary-hover: 270 70% 50%;
      }
      
      [data-theme="liquor"] {
        --primary-hover: 0 84% 55%;
      }
      
      [data-theme="grocery"] {
        --primary-hover: 142 76% 32%;
      }
    </style>
  </head>
  <body className="min-h-screen flex items-center justify-center p-8 relative overflow-hidden">
    <div id="root" className="relative z-10 w-full max-w-md mx-auto"></div>
    
    <script>
      // Version check to force reload of cached pages
      (function() {
        const CURRENT_VERSION = '3.0.6';
        const VERSION_KEY = 'store-insights-html-version';
        const storedVersion = localStorage.getItem(VERSION_KEY);
        
        if (storedVersion !== CURRENT_VERSION) {
          // Clear all cached data and force reload
          localStorage.setItem(VERSION_KEY, CURRENT_VERSION);
          // Force a hard reload to bypass cache
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
              for(let registration of registrations) {
                registration.unregister();
              }
            });
          }
          // Use location.reload(true) for older browsers, or location.replace for newer
          if (window.location.search.indexOf('nocache') === -1) {
            window.location.replace(window.location.href + (window.location.search ? '&' : '?') + 'nocache=' + Date.now());
          }
        }
      })();
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Component Library -->
    <script src="/theme-switcher.js"></script>
    <script src="/components/component-loader.js"></script>
    <script type="text/babel">
      const { useState, useEffect, useRef } = React;
      
      // Wait for components to load before rendering
      (async function waitForComponents() {
        // Wait up to 3 seconds for components to load
        const maxWait = 3000;
        const startTime = Date.now();
        
        while (!window.componentsLoaded && (Date.now() - startTime) < maxWait) {
          await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        if (!window.componentsLoaded) {
          console.error('Components failed to load within timeout');
          console.error('Check network tab for component file loading errors');
        }
      })();
      
      // Verify components are loaded
      if (typeof Button === 'undefined') {
        console.error('Button component not found. Component library may not have loaded.');
        console.error('Components loaded:', window.componentsLoaded);
      }
      if (typeof Input === 'undefined') {
        console.error('Input component not found. Component library may not have loaded.');
      }

      const API_BASE = window.location.origin;

      // Storage helper
      const storage = {
        get: (key, defaultValue) => {
          try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : defaultValue;
          } catch {
            return defaultValue;
          }
        },
        set: (key, value) => {
          try {
            localStorage.setItem(key, JSON.stringify(value));
          } catch {}
        },
        remove: (key) => {
          try {
            localStorage.removeItem(key);
          } catch {}
        },
      };

      const STORAGE_KEYS = {
        token: 'store-insights/token',
        adminKey: 'store-insights/admin-key',
        role: 'store-insights/role',
        profile: 'store-insights/profile',
        stores: 'store-insights/stores',
        selectedStore: 'store-insights/selected-store',
      };

      // Components (Button, Input, Label are now loaded from component library)
      // Login page uses Button with custom hover via --primary-hover CSS variable
      const LoginForm = ({ onSubmit, isLoading, error }) => {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');

        const submit = (event) => {
          event.preventDefault();
          onSubmit({ email, password });
        };

        return (
          <form onSubmit={submit} className="space-y-5">
            <div className="space-y-2">
              <Label htmlFor="email">Email</Label>
              <Input
                id="email"
                type="email"
                placeholder="you@example.com"
                value={email}
                onChange={(event) => setEmail(event.target.value)}
                required
                disabled={isLoading}
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="password">Password</Label>
              <Input
                id="password"
                type="password"
                placeholder="••••••••"
                value={password}
                onChange={(event) => setPassword(event.target.value)}
                required
                disabled={isLoading}
              />
            </div>
            {error && (
              <div className="rounded-lg bg-destructive/10 border border-destructive/50 p-4 text-destructive font-semibold text-sm shadow-sm">
                {error}
              </div>
            )}
            <Button type="submit" variant="default" disabled={isLoading} className="w-full">
              {isLoading ? 'Signing in…' : 'Sign in'}
            </Button>
          </form>
        );
      };

      const LoginSelection = ({ onSelectInsights, onSelectMobility }) => {
        const handleInsightsClick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          onSelectInsights();
        };

        const handleMobilityClick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          onSelectMobility();
        };

        return (
          <div className="space-y-4">
            <Button
              type="button"
              variant="outline"
              size="lg"
              onClick={handleInsightsClick}
              className="w-full min-h-[48px] text-base font-semibold border-2 shadow-md hover:shadow-lg active:scale-[0.98] touch-manipulation select-none"
              onTouchStart={(e) => {
                e.currentTarget.style.transform = 'scale(0.98)';
              }}
              onTouchEnd={(e) => {
                e.currentTarget.style.transform = '';
                handleInsightsClick(e);
              }}
            >
              Login to Spirits Insights
            </Button>
            <Button
              type="button"
              variant="outline"
              size="lg"
              onClick={handleMobilityClick}
              className="w-full min-h-[48px] text-base font-semibold border-2 shadow-md hover:shadow-lg active:scale-[0.98] touch-manipulation select-none"
              onTouchStart={(e) => {
                e.currentTarget.style.transform = 'scale(0.98)';
              }}
              onTouchEnd={(e) => {
                e.currentTarget.style.transform = '';
                handleMobilityClick(e);
              }}
            >
              Login to Spirits Mobility
            </Button>
          </div>
        );
      };

      const MobilityConnectionForm = ({ onConnect, onBack, isLoading, error }) => {
        const savedIp = localStorage.getItem('spirits_mobility_ip');
        const savedPort = localStorage.getItem('spirits_mobility_port');
        const hasSavedConnection = Boolean(savedIp && savedPort);
        
        const [serverIp, setServerIp] = useState(savedIp || '');
        const [serverPort, setServerPort] = useState(savedPort || '8080');
        const [isEditing, setIsEditing] = useState(!hasSavedConnection);
        const [countdown, setCountdown] = useState(hasSavedConnection ? 12 : null);
        const [isConnecting, setIsConnecting] = useState(false);

        useEffect(() => {
          if (hasSavedConnection && !isEditing && countdown !== null && countdown > 0) {
            const timer = setTimeout(() => {
              setCountdown(countdown - 1);
            }, 1000);
            return () => clearTimeout(timer);
          } else if (hasSavedConnection && !isEditing && countdown === 0 && !isConnecting) {
            setIsConnecting(true);
            onConnect(serverIp, serverPort);
          }
        }, [countdown, hasSavedConnection, isEditing, isConnecting, serverIp, serverPort, onConnect]);

        const handleEdit = () => {
          setIsEditing(true);
          setCountdown(null);
        };

        const handleConnect = (event) => {
          event?.preventDefault();
          if (serverIp && serverPort) {
            setIsConnecting(true);
            localStorage.setItem('spirits_mobility_ip', serverIp);
            localStorage.setItem('spirits_mobility_port', serverPort);
            onConnect(serverIp, serverPort);
          }
        };

        return (
          <div className="space-y-5 mt-2 pt-6 border-t border-border">
            <h2 className="text-center text-xl font-semibold text-foreground mb-4">
              Logging into Spirits Mobility
            </h2>
            <form onSubmit={handleConnect} className="space-y-5">
              <div className="space-y-2">
                <Label htmlFor="server-ip">Server IP Address</Label>
                <Input
                  id="server-ip"
                  type="text"
                  placeholder="192.168.1.100"
                  value={serverIp}
                  onChange={(event) => setServerIp(event.target.value)}
                  required
                  disabled={!isEditing || isConnecting}
                  readOnly={!isEditing}
                  className={!isEditing ? 'bg-muted text-muted-foreground border-muted cursor-default' : ''}
                  pattern={isEditing ? "^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$|^[a-zA-Z0-9]([a-zA-Z0-9\\-]{0,61}[a-zA-Z0-9])?(\\.[a-zA-Z0-9]([a-zA-Z0-9\\-]{0,61}[a-zA-Z0-9])?)*$" : undefined}
                  title={isEditing ? "Enter a valid IP address or hostname" : undefined}
                />
              </div>
              <div className="grid grid-cols-[2fr_1fr] gap-4">
                <div className="space-y-2">
                  <Label htmlFor="server-port">Port</Label>
                  <Input
                    id="server-port"
                    type="number"
                    placeholder="8080"
                    value={serverPort}
                    onChange={(event) => setServerPort(event.target.value)}
                    required
                    min="1"
                    max="65535"
                    disabled={!isEditing || isConnecting}
                    readOnly={!isEditing}
                    className={!isEditing ? 'bg-muted text-muted-foreground border-muted cursor-default' : ''}
                  />
                </div>
              </div>
              {!isEditing && hasSavedConnection && (
                <Button
                  type="button"
                  variant="secondary"
                  onClick={handleEdit}
                  disabled={isConnecting}
                  className="w-full mt-2"
                >
                  Edit
                </Button>
              )}
              {error && (
                <div className="rounded-lg bg-destructive/10 border border-destructive/50 p-4 text-destructive font-semibold text-sm shadow-sm">
                  {error}
                </div>
              )}
              {!isEditing && hasSavedConnection && countdown !== null && (
                <div className="text-center text-foreground text-sm py-3 px-3 bg-accent/20 rounded-lg border border-accent">
                  Redirecting in {countdown} second{countdown !== 1 ? 's' : ''}...
                </div>
              )}
              <div className="grid grid-cols-2 gap-3 mt-2">
                <Button type="button" variant="secondary" onClick={onBack} disabled={isConnecting} className="w-full">
                  Back
                </Button>
                {isEditing ? (
                  <Button type="submit" variant="default" disabled={isConnecting || !serverIp || !serverPort} className="w-full">
                    {isConnecting ? 'Connecting…' : 'Connect'}
                  </Button>
                ) : (
                  <Button type="button" variant="default" onClick={handleConnect} disabled={isConnecting} className="w-full">
                    {isConnecting ? 'Connecting…' : 'Continue'}
                  </Button>
                )}
              </div>
            </form>
          </div>
        );
      };

      const LoginApp = () => {
        // Always start with selection view - force it to prevent caching issues
        const [loginView, setLoginView] = useState(() => {
          // Clear any old state that might be cached
          return 'selection';
        });
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState('');
        const [isConnectingMobility, setIsConnectingMobility] = useState(false);
        const [mobilityError, setMobilityError] = useState('');

        // Ensure we always show selection screen on mount
        useEffect(() => {
          setLoginView('selection');
        }, []);

        const handleLogin = async ({ email, password }) => {
          setIsLoading(true);
          setError('');

          try {
            const response = await fetch(`${API_BASE}/auth/login`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, password }),
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.detail || 'Login failed');
            }

            // Store all login data in localStorage before redirecting
            storage.set(STORAGE_KEYS.token, data.token);
            
            // Store role
            if (data.role) {
              storage.set(STORAGE_KEYS.role, data.role);
            }
            
            // Store profile
            if (data.email || data.full_name) {
              storage.set(STORAGE_KEYS.profile, {
                email: data.email || '',
                full_name: data.full_name || '',
              });
            }
            
            // Store stores and set initial selectedStore
            if (data.stores && Array.isArray(data.stores) && data.stores.length > 0) {
              storage.set(STORAGE_KEYS.stores, data.stores);
              // Helper to get store identifier (same logic as dashboard)
              const getStoreIdentifier = (store) => {
                if (!store) return '';
                if (store.store_id !== undefined && store.store_id !== null) {
                  return String(store.store_id);
                }
                if (store.store_db) {
                  return String(store.store_db);
                }
                if (store.store_name) {
                  return String(store.store_name);
                }
                if (store.id) {
                  return String(store.id);
                }
                return '';
              };
              
              // Set first store as selected (or restore from localStorage if available)
              const savedStore = storage.get(STORAGE_KEYS.selectedStore, null);
              let initialStore = null;
              if (savedStore) {
                // Try to find matching store using identifier
                const savedIdentifier = getStoreIdentifier(savedStore);
                if (savedIdentifier) {
                  const match = data.stores.find((s) => {
                    const sIdentifier = getStoreIdentifier(s);
                    return sIdentifier && savedIdentifier && sIdentifier === savedIdentifier;
                  });
                  if (match) {
                    initialStore = match;
                  }
                }
              }
              if (!initialStore) {
                initialStore = data.stores[0];
              }
              storage.set(STORAGE_KEYS.selectedStore, initialStore);
            } else {
              // No stores, clear any old store data
              storage.remove(STORAGE_KEYS.stores);
              storage.remove(STORAGE_KEYS.selectedStore);
            }
            
            // Store admin key if present
            if (data.admin_key) {
              storage.set(STORAGE_KEYS.adminKey, data.admin_key);
            } else {
              storage.remove(STORAGE_KEYS.adminKey);
            }

            // Redirect based on role
            // Admin users go directly to admin panel, others go to dashboard
            const role = data.role || 'owner';
            if (role === 'admin') {
              window.location.href = '/admin.html';
            } else {
              window.location.href = '/dashboard.html';
            }
          } catch (err) {
            setError(err.message || 'Login failed. Please check your credentials.');
          } finally {
            setIsLoading(false);
          }
        };

        const handleMobilityConnect = (ip, port) => {
          setIsConnectingMobility(true);
          setMobilityError('');
          
          const mobilityUrl = `http://${ip}:${port}/index.html`;
          
          // Modern browsers block HTTPS->HTTP navigation, but we can try opening in new tab
          // which is often allowed. The user can then close the tab to return.
          // Do this immediately while we still have the user gesture context
          try {
            // Try to open in same window first
            const link = document.createElement('a');
            link.href = mobilityUrl;
            link.target = '_self';
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          } catch (error) {
            // If that fails, open in new tab (browsers usually allow this)
            console.log('Opening Spirits Mobility in new tab due to browser security restrictions');
            window.open(mobilityUrl, '_blank');
          }
        };

        return (
          <div className="w-full max-w-md mx-auto relative z-10">
            <div className="w-full bg-card text-card-foreground rounded-lg p-8 md:p-12 grid gap-8 shadow-lg border border-border">
              <div>
                <h1 className="m-0 text-center text-3xl md:text-4xl font-bold text-foreground tracking-tight">
                  Spirits Store Insights
                </h1>
                <p className="m-0 text-center text-muted-foreground text-base mt-2">
                  Choose your login option to continue.
                </p>
              </div>
              {loginView === 'selection' && (
                <LoginSelection
                  onSelectInsights={() => setLoginView('insights')}
                  onSelectMobility={() => setLoginView('mobility')}
                />
              )}
              {loginView === 'insights' && (
                <>
                  <LoginForm onSubmit={handleLogin} isLoading={isLoading} error={error} />
                  <Button
                    type="button"
                    variant="secondary"
                    onClick={() => setLoginView('selection')}
                    className="w-full mt-2"
                  >
                    Back
                  </Button>
                </>
              )}
              {loginView === 'mobility' && (
                <MobilityConnectionForm
                  onConnect={handleMobilityConnect}
                  onBack={() => setLoginView('selection')}
                  isLoading={isConnectingMobility}
                  error={mobilityError}
                />
              )}
            </div>
          </div>
        );
      };

      // Store app component for rendering after components load
      window.renderLoginApp = function() {
        if (typeof Button === 'undefined' || typeof Input === 'undefined') {
          console.error('Components not loaded. Waiting...');
          setTimeout(window.renderLoginApp, 100);
          return;
        }
        ReactDOM.render(<LoginApp />, document.getElementById('root'));
      };
    </script>
    <script>
      // Render app after components are loaded
      (function() {
        function tryRender() {
          if (window.componentsLoaded && typeof Button !== 'undefined') {
            if (window.renderLoginApp) {
              window.renderLoginApp();
            }
          } else {
            setTimeout(tryRender, 50);
          }
        }
        
        // Listen for components loaded event
        window.addEventListener('componentsLoaded', function() {
          if (window.renderLoginApp) {
            window.renderLoginApp();
          }
        });
        
        // Also try periodically (fallback)
        tryRender();
      })();
    </script>
  </body>
</html>